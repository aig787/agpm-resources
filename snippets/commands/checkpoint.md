# Checkpoint Command

## Purpose

Implement a Git-based checkpoint that creates a detached commit to preserve the full state of changes without polluting the branch history.

## Command: `checkpoint create`

Creates a checkpoint commit that is NOT on the current branch:

### 1. Verify state
```bash
# Check if there are changes to checkpoint
git status --porcelain
# If no changes, inform user and exit
```

### 2. Save current branch
```bash
CURRENT_BRANCH=$(git branch --show-current)
CURRENT_HEAD=$(git rev-parse HEAD)
```

### 3. Analyze changes for commit message
- Count files changed, insertions, deletions
- Identify primary areas of change (src/, tests/, docs/, etc.)
- List key modifications (new features, refactors, fixes)
- If --message provided, incorporate it

### 4. Create checkpoint commit (detached from branch)
```bash
# Stage all changes (including untracked files for complete snapshot)
git add -A

# Create the checkpoint commit with detailed message
git commit --author="Claude <noreply@anthropic.com>" -m "$(cat <<'EOF'
üîí Checkpoint: [Summary of changes]

Context: [User-provided message or "AI-assisted development session"]

Changes:
- [X files changed, Y insertions, Z deletions]
- Primary areas: [src/, tests/, docs/]
- Key modifications:
  * [List major changes]
  * [Include file patterns]

Branch: $CURRENT_BRANCH
Parent: $CURRENT_HEAD

This checkpoint preserves the complete working state and can be restored using:
checkpoint restore [commit-sha]

ü§ñ Generated by Claude Code
EOF
)"

# Get the checkpoint commit SHA
CHECKPOINT_SHA=$(git rev-parse HEAD)

# CRITICAL: Move the branch pointer back (keeping checkpoint detached)
git reset --mixed $CURRENT_HEAD

# Save checkpoint reference to .git/refs/checkpoints/ for easy access
mkdir -p .git/refs/checkpoints
echo $CHECKPOINT_SHA > .git/refs/checkpoints/$(date +%Y%m%d_%H%M%S)_$CHECKPOINT_SHA

# Restore working directory state
git add -A
```

### 5. Report success
```
‚úÖ Checkpoint created: $CHECKPOINT_SHA
üìç Checkpoint is detached from branch history
üíæ Working directory preserved as-is

To restore this checkpoint later:
/checkpoint restore $CHECKPOINT_SHA
```

## Command: `checkpoint restore [target]`

Restores to a checkpoint or commit:

### 1. Parse target
- If no target: show recent checkpoints and ask user to choose
- If target is SHA: use directly
- If target is "latest": use most recent checkpoint
- If target is relative (HEAD~1, etc.): resolve it

### 2. Confirm with user
```bash
# Show what will be lost
git diff --stat HEAD

echo "‚ö†Ô∏è  WARNING: This will restore to checkpoint $TARGET"
echo "üìù Current uncommitted changes will be LOST"
echo "üîç Current branch: $(git branch --show-current)"
```

### 3. Create safety checkpoint first (unless --no-backup)
```bash
# Before destroying current state, checkpoint it
git add -A
SAFETY_SHA=$(git stash create "safety-checkpoint-before-restore")
echo $SAFETY_SHA > .git/refs/checkpoints/safety_$(date +%s)
```

### 4. Perform restoration
```bash
# Hard reset to checkpoint
git reset --hard $TARGET

# If checkpoint was detached, reset back to branch tip and apply changes
if [[ ! $(git branch --contains $TARGET 2>/dev/null) ]]; then
  # Get the original branch from checkpoint message
  ORIG_BRANCH=$(git log -1 --pretty=%B $TARGET | grep "Branch:" | cut -d: -f2)
  ORIG_PARENT=$(git log -1 --pretty=%B $TARGET | grep "Parent:" | cut -d: -f2)

  # Reset to original parent
  git reset --hard $ORIG_PARENT

  # Cherry-pick the checkpoint changes (without committing)
  git cherry-pick -n $TARGET
fi
```

### 5. Report result
```
‚úÖ Restored to checkpoint: $TARGET
üìù Working directory updated
üíæ Safety checkpoint saved: $SAFETY_SHA
```

## Command: `checkpoint list`

Shows available checkpoints:

```bash
# List checkpoints from refs
echo "üìç Available checkpoints:"
echo ""

# Check .git/refs/checkpoints/
if [ -d .git/refs/checkpoints ]; then
  for checkpoint in .git/refs/checkpoints/*; do
    if [ -f "$checkpoint" ]; then
      SHA=$(cat $checkpoint)
      NAME=$(basename $checkpoint)
      DATE=$(echo $NAME | cut -d_ -f1-2 | tr _ ' ')

      # Get commit message summary
      MSG=$(git log -1 --pretty=%s $SHA 2>/dev/null || echo "[Checkpoint not found]")
      STATS=$(git diff --stat $SHA^..$SHA 2>/dev/null | tail -1 || echo "")

      echo "  $NAME"
      echo "    SHA: $SHA"
      echo "    Date: $DATE"
      echo "    Message: $MSG"
      echo "    Changes: $STATS"
      echo ""
    fi
  done
else
  echo "  No checkpoints found"
fi

# Also show recent commits with checkpoint marker
echo "üìù Recent checkpoint commits:"
git log --oneline --author="noreply@anthropic.com" -10 | grep "üîí Checkpoint" || echo "  No checkpoint commits found"
```

## Command: `checkpoint clean`

Removes old checkpoint references:

```bash
# Clean checkpoint refs older than 7 days
echo "üßπ Cleaning old checkpoints..."

if [ -d .git/refs/checkpoints ]; then
  find .git/refs/checkpoints -type f -mtime +7 -delete
  echo "‚úÖ Removed checkpoints older than 7 days"
else
  echo "üìç No checkpoints to clean"
fi

# Also run git gc to clean up unreachable commits
git gc --prune=now --aggressive
echo "‚úÖ Git garbage collection complete"
```

## Implementation Notes

### Key Design Decisions

1. **Detached Commits**: Checkpoints are created as commits but immediately detached from the branch by resetting the branch pointer back. This keeps branch history clean.

2. **Complete State Capture**: Uses `git add -A` to capture ALL changes including untracked files, ensuring complete state preservation.

3. **Safety First**: Before any restore operation, creates a safety checkpoint automatically.

4. **Rich Metadata**: Checkpoint commits include detailed information about the context, changes, and restoration instructions.

5. **Reference Management**: Stores checkpoint SHAs in `.git/refs/checkpoints/` for easy discovery and management.

### Differences from Regular Commits

- Uses special author: `Claude <noreply@anthropic.com>`
- Creates detached commits (not on branch)
- Includes checkpoint emoji marker üîí
- Captures complete working directory state
- Provides restoration instructions in commit message

### Error Handling

- Check for uncommitted changes before operations
- Verify Git repository exists
- Handle missing checkpoints gracefully
- Provide clear error messages and recovery options

## Examples

```bash
# Create a checkpoint before major refactoring
/checkpoint create --message "Before refactoring cache module"

# List available checkpoints
/checkpoint list

# Restore to the latest checkpoint
/checkpoint restore latest

# Restore to specific checkpoint
/checkpoint restore abc123

# Clean old checkpoints
/checkpoint clean
```

## Safety Considerations

‚ö†Ô∏è **Restoration is destructive**: Always creates a safety checkpoint before restore
üìù **Checkpoints are temporary**: Not pushed to remote, local-only
üîí **Privacy**: Checkpoints may contain sensitive uncommitted data
üßπ **Maintenance**: Run `checkpoint clean` periodically to avoid bloat